%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% <TEI> generic (LaTeX names generated by Teinte) %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This template is inserted in a specific design
% It is XeLaTeX and otf fonts

\makeatletter % <@@@

\setlength{\parindent}{1.5em}

\usepackage{adjustbox} % powerful 
\usepackage{alphalph} % for alph couter z, aa, ab…
\usepackage{booktabs} % better table border
\usepackage[strict]{changepage} % for modulo 4
\usepackage{contour} % rounding words
\usepackage[nodayofweek]{datetime}
\usepackage{enumitem} % <list>
\usepackage{etoolbox} % patch commands
\usepackage{fancyvrb}
\usepackage{fancyhdr} % control runing heads
\usepackage{float} % supposed a better positionning of tables
\usepackage[stable]{footmisc} % maybe perpage footnote counter
\usepackage{fontspec} % XeLaTeX mandatory for fonts
\usepackage{footnotehyper} % \savenotes \spewnotes
\usepackage{graphicx} % needed for LuaLaTex to transmit a5paper
\usepackage{lastpage} % p. # of ## 
\usepackage{lettrine} % drop caps
\usepackage{manyfoot} % for parallel footnote numerotation
\usepackage[framemethod=tikz,]{mdframed} % maybe used for frame, but with footnotes inside
\usepackage{multirow} % table, for colspan and rowspan 
\usepackage[defaultlines=2,all]{nowidow} % at least 2 lines by par (works well!)
\usepackage[roman]{parnotes} % notes attaches to tables
\usepackage{pdftexcmds} % needed for tests expressions
\usepackage{poetry} % <l>, bad for theater
\usepackage[%
  indentfirst=true,
  vskip=1em,
  noorphanfirst=true,
  noorphanafter=true,
  leftmargin=\parindent,
  rightmargin=0pt,
]{quoting}
\usepackage{ragged2e}
\usepackage{relsize} % \smaller \larger (ex: quotes in body and footnotes)
\usepackage{setspace} % \setstretch for <quote>
\usepackage{scrextend} % KOMA-common, used for addmargin
\usepackage{tabularx, colortbl} % for tables
\usepackage{tikz} % ornaments
\usetikzlibrary{tikzmark} % to point tikzmarknode
\usepackage[most]{tcolorbox}
\usepackage[explicit]{titlesec} % wear titles, !NO implicit
\usepackage{tocloft} % styling tocs
\usepackage[fit]{truncate} % used in runing titles
\usepackage{unicode-math} % math for XeLaTeX or LuaLaTeX
\usepackage[normalem]{ulem} % breakable \uline, normalem is absolutely necessary to keep \emph
\usepackage{xcolor} % named colors
\usepackage{xparse} % @ifundefined
\usepackage{xstring} % needed for tests, ex \pn

% for testing, not production
\usepackage{blindtext} % generate text for testing
\usepackage{lipsum} % generate text for testing


\defaultfontfeatures{
  % Mapping=tex-text, % no effect seen
  Scale=MatchLowercase,
  Ligatures={TeX,Common},
}

% tabularx 
\renewcommand\tabularxcolumn[1]{m{#1}} % for vertical centering text in X column
\setlength{\cmidrulewidth}{0.2pt} 
% \setlength{\tabcolsep}{3pt} % ?
\renewcommand{\arraystretch}{1.3} % space between rows
\newcommand{\tablestart}{\centering\setstretch{0.8}\sffamily}

% Metadata inserted by a program, from the TEI source, for title page and runing heads

%meta%


% Default metas
\newcommand{\colorprovide}[2]{\@ifundefinedcolor{#1}{\colorlet{#1}{#2}}{}}
\colorprovide{rubric}{red}
\colorprovide{silver}{lightgray}
\@ifundefined{syms}{\newfontfamily\syms{DejaVu Sans}}{}


% generic typo commands
\newcommand{\astermono}{\medskip\centerline{\color{rubric}\large\selectfont{\syms ✻}}\medskip\par}%
\newcommand{\astertri}{\medskip\par\centerline{\color{rubric}\large\selectfont{\syms ✻\,✻\,✻}}\medskip\par}%
\newcommand{\asterism}{\bigskip\par\noindent\parbox{\linewidth}{\centering\color{rubric}\large{\syms ✻}\\{\syms ✻}\hskip 0.75em{\syms ✻}}\bigskip\par}%

% lists
\newlength{\listmod}
\setlength{\listmod}{\parindent}
\setlist{
  itemindent=!,
  listparindent=\listmod,
  labelsep=0.2\listmod,
  parsep=0pt,
  % topsep=0.2em, % default topsep is best
}
\setlist[itemize]{
  label=—,
  leftmargin=0pt,
  labelindent=1.2em,
  labelwidth=0pt,
}
\setlist[enumerate]{
  label={\arabic*°},
  labelindent=0.8\listmod,
  leftmargin=\listmod,
  labelwidth=0pt,
}
% list for big items
\newlist{decbig}{enumerate}{1}
\setlist[decbig]{
  label={\bf\color{rubric}\arabic*.},
  labelindent=0.8\listmod,
  leftmargin=\listmod,
  labelwidth=0pt,
}
\newlist{listalpha}{enumerate}{1}
\setlist[listalpha]{
  label={\bf\color{rubric}\alph*.},
  leftmargin=0pt,
  labelindent=0.8\listmod,
  labelwidth=0pt,
}
\newcommand{\listhead}[1]{\hspace{-1\listmod}\emph{#1}}

\renewcommand{\hrulefill}{%
  \leavevmode\leaders\hrule height 0.2pt\hfill\kern\z@}

% General typo
\DeclareTextFontCommand{\textlarge}{\large}
\DeclareTextFontCommand{\textsmall}{\small}

% commands, inlines
\newcommand{\anchor}[1]{\Hy@raisedlink{\hypertarget{#1}{}}} % link to top of an anchor (not baseline)
\newcommand\abbr[1]{#1}
\newcommand{\autour}[1]{\tikz[baseline=(X.base)]\node [draw=rubric,thin,rectangle,inner sep=1.5pt, rounded corners=3pt] (X) {\color{rubric}#1};}
\newcommand\corr[1]{#1}
\newcommand{\ed}[1]{ {\color{silver}\sffamily\footnotesize (#1)} } % <milestone ed="1688"/>
\newcommand\expan[1]{#1}
\newcommand\foreign[1]{\emph{#1}}
\newcommand\gap[1]{#1}
\renewcommand{\LettrineFontHook}{\color{rubric}}
\newcommand{\initial}[2]{\lettrine[lines=2, loversize=0.3, lhang=0.3]{#1}{#2}}
\newcommand{\initialiv}[2]{%
  \let\oldLFH\LettrineFontHook
  % \renewcommand{\LettrineFontHook}{\color{rubric}\ttfamily}
  \IfSubStr{QJ’}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=-0.1, lraise=0.2]{\smash{#1}}{#2}
  }{\IfSubStr{É}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=-0, lraise=0]{\smash{#1}}{#2}
  }{\IfSubStr{ÀÂ}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=-0, lraise=0, slope=0.6em]{\smash{#1}}{#2}
  }{\IfSubStr{A}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=0.2, slope=0.6em]{\smash{#1}}{#2}
  }{\IfSubStr{V}{#1}{
    \lettrine[lines=4, lhang=0.2, loversize=0.2, slope=-0.5em]{\smash{#1}}{#2}
  }{
    \lettrine[lines=4, lhang=0.2, loversize=0.2]{\smash{#1}}{#2}
  }}}}}
  \let\LettrineFontHook\oldLFH
}
\newcommand{\labelchar}[1]{\textbf{\color{rubric} #1}}
\newcommand{\lnatt}[1]{\reversemarginpar\marginpar[\sffamily\scriptsize #1]{}}
\newcommand{\milestone}[1]{\autour{\footnotesize\color{rubric} #1}} % <milestone n="4"/>
\newcommand\name[1]{#1}
\newcommand\orig[1]{#1}
\newcommand\orgName[1]{#1}
\newcommand\parnoindent{\noindent} % special para
\newcommand\pb[1]{{\small\sffamily\normalfont [p. #1]}} 
\newcommand\persName[1]{#1}
\newcommand\placeName[1]{#1}
\newcommand{\pn}[1]{\IfSubStr{-—–¶}{#1}% <p n="3"/>
  {\noindent{\bfseries\color{rubric}   ¶  }}
  {{\footnotesize\autour{#1}}}}
\newcommand\reg{}
% \newcommand\ref{} % already defined
\newcommand\sic[1]{#1}
\newcommand\surname[1]{\textsc{#1}}
\newcommand\term[1]{\textbf{#1}}


\def\mednobreak{\ifdim\lastskip<\medskipamount
  \removelastskip\nopagebreak\medskip\fi}
\def\bignobreak{\ifdim\lastskip<\bigskipamount
  \removelastskip\nopagebreak\bigskip\fi}

% commands, blocks

\newcommand{\byline}[1]{\bigskip{\RaggedLeft{#1}\par}\bigskip}
% \setlength{\RaggedLeftLeftskip}{2em plus \leftskip}
\newcommand{\bibl}[1]{{\RaggedLeft\upshape #1\par}}
\newcommand{\biblitem}[1]{{\noindent\hangindent=\parindent   #1\par}}
\newcommand{\castItem}[1]{{\noindent\hangindent=\parindent #1\par}}
\newcommand{\dateline}[1]{
  \widowpenalty=-5000\nopagebreak[4]
  \medskip
  {\RaggedLeft{#1}\par}
  \pagebreak[0]
  \bigskip
}
\newcommand{\docAuthor}[1]{{\large\bigskip #1 \par\bigskip}}
\newcommand{\docDate}[1]{#1 \ifvmode\par\fi }
\newcommand{\docImprint}[1]{\ifvmode\medskip\fi #1 \ifvmode\par\fi }
\newcommand{\labelblock}[1]{\medbreak{\noindent\color{rubric}\bfseries #1}\par\mednobreak}
\newcommand{\question}[1]{\bigbreak{\RaggedRight\noindent\emph{#1}\par}\mednobreak}
\newcommand{\salute}[1]{\bigbreak{#1}\par\medbreak}
\newcommand{\signed}[1]{\medskip{\RaggedLeft #1\par}\bigbreak} % supposed bottom
\newcommand{\speaker}[1]{\medskip{\Centering\sffamily #1 \par\nopagebreak}} % supposed bottom
\newcommand{\stagescene}[1]{{\Centering\sffamily\textsf{#1}\par}\bigskip}
\newcommand{\stageblock}[1]{\begingroup\leftskip\parindent\noindent\it\sffamily\footnotesize #1\par\endgroup} % left margin, better than list envs
\newcommand{\lpar}[1]{\noindent\hangindent=2\parindent  #1\par} % sp/l
\newcommand{\trailer}[1]{{\Centering\bigskip #1\par}} % sp/l

% environments for blocks (some may become commands)
\newenvironment{borderbox}{}{} % framing content
\newenvironment{citbibl}{\ifvmode\hfill\fi}{\ifvmode\par\fi }
\newenvironment{msHead}{\vskip6pt}{\par}
\newenvironment{msItem}{\vskip6pt}{\par}


% environments for block containers
\newenvironment{argument}{\itshape\parindent0pt}{\bigskip}
\newenvironment{biblfree}{}{\ifvmode\par\fi }
% memoir has already bibitemlist
\newenvironment{bibitemlist}[1]{%
  \list{\@biblabel{\@arabic\c@enumiv}}%
  {%
    \settowidth\labelwidth{\@biblabel{#1}}%
    \leftmargin\labelwidth
    \advance\leftmargin\labelsep
    \@openbib@code
    \usecounter{enumiv}%
    \let\p@enumiv\@empty
    \renewcommand\theenumiv{\@arabic\c@enumiv}%
  }
  \sloppy
  \clubpenalty4000
  \@clubpenalty \clubpenalty
  \widowpenalty4000%
  \sfcode`\.\@m
}%
{\def\@noitemerr
  {\@latex@warning{Empty `bibitemlist' environment}}%
\endlist}
\newenvironment{docTitle}{\LARGE\bigskip\bfseries\onehalfspacing}{\bigskip}
% leftskip makes big bugs in Lexmark printing \sffamily
\newenvironment{epigraph}{\begin{addmargin}[2\parindent]{0em}\sffamily\large\setstretch{0.95}}{\end{addmargin}\bigskip}

% tcolorbox is bad for footnotes in quotes
\definecolor{bordercolor}{HTML}{CCCCCC}

\newenvironment{quoteblock}
  {
    \medskip
    \sffamily
  }
  {
    \medskip
  }

\newenvironment{frametext}
  {\begin{mdframed}[default]} %
  {\end{mdframed}}

\newenvironment{titlePage}
  {\Centering}
  {}


% text structure
\newenvironment{chapterhead}{}{} % a container for chapter headings and more
\setcounter{secnumdepth}{-2} % no counters for hierarchy titles
\setcounter{tocdepth}{5} % deep toc
\def\chaptermark#1{\markboth{#1}{}} % no upper case for running header
% toclof format
% \renewcommand{\@tocrmarg}{0.1em} % Useless command?
% \renewcommand{\@pnumwidth}{0.5em} % {1.75em}
\renewcommand{\@cftmaketoctitle}{}
\setlength{\cftbeforesecskip}{\z@ \@plus.2\p@}

\@ifclassloaded{article}{%
  \typeout{class: article}%
}{%
  \renewcommand{\cftchapfont}{}
  \renewcommand{\cftchapdotsep}{\cftdotsep}
  \renewcommand{\cftchapleader}{\mdseries\cftdotfill{\cftchapdotsep}}
  \renewcommand{\cftchappagefont}{\mdseries}
  \setlength{\cftbeforechapskip}{0pt}
  \setlength{\cftchapnumwidth}{1em}
}
% section
\renewcommand{\cftsecfont}{\mdseries}
\renewcommand{\cftsecdotsep}{\cftdotsep}
\renewcommand{\cftsecpagefont}{\mdseries}
\renewcommand{\cftsecleader}{\mdseries\cftdotfill{\cftsecdotsep}}
\setlength{\cftsecindent}{1em}
\setlength{\cftsecnumwidth}{1em}

% sub section
\renewcommand{\cftsubsecfont}{}
\renewcommand{\cftsubsecpagefont}{}
\setlength{\cftsubsecindent}{2em}
\setlength{\cftsubsecnumwidth}{1em}

% sub sub section
\setlength{\cftsubsubsecindent}{3em}
\setlength{\cftsubsubsecnumwidth}{1em}

% footnotes
\newif\ifheading
% \newcommand*{\fnmarkscale}{\ifheading 0.70 \else 1 \fi}
\renewcommand\footnoterule{
  \vspace*{0.5em}
  {\color{gray}\hrule height \arrayrulewidth width .2\linewidth} 
  \vspace*{0.5em}
}
\setlength\footnotesep{1.5\footnotesep} % footnote separator
\DeclareNewFootnote{N}[arabic]
\DeclareNewFootnote{A}[alph] % for editor notes
\renewcommand*{\thefootnoteA}{\alphalph{\value{footnoteA}}} % z, aa, ab…

% poem
\setlength{\poembotskip}{0pt}
\setlength{\poemtopskip}{0pt}
\setlength{\poemindent}{0pt}
\setlength{\poemmaxlinewd}{\linewidth}
\poemlinenumsfalse

%   see https://tex.stackexchange.com/a/34449/5049
\def\truncdiv#1#2{((#1-(#2-1)/2)/#2)}
\def\moduloop#1#2{(#1-\truncdiv{#1}{#2}*#2)}
\def\modulo#1#2{\number\numexpr\moduloop{#1}{#2}\relax}

% orphans and widows, nowidow package in test
% from memoir package
\clubpenalty=9996
\widowpenalty=9999
\brokenpenalty=4991
\predisplaypenalty=10000
\postdisplaypenalty=1549
\displaywidowpenalty=1602
\hyphenpenalty=400
% report h or v overfull ?
% \hbadness=4000
% \vbadness=4000
% https://tex.stackexchange.com/questions/62296/how-to-suppress-underfull-vbox-badness-10000-while-output-is-active
\def\@textbottom{\vskip \z@ \@plus 1pt}
\let\@texttop\relax
% good to avoid lines too wide
\emergencystretch 3em
\pretolerance=750
\tolerance=2000
\def\Gin@extensions{.pdf,.png,.jpg,.jpeg,.mps,.tif}

\PassOptionsToPackage{hyphens}{url} % before hyperref and biblatex, which load url package
\usepackage[
  linkbordercolor={0 0 0}, % hyperlink borderscolor
]{hyperref} % supposed to be the last one, :o) except for the ones to follow
\hypersetup{
  % pdftex, % no effect
  pdftitle={\elbibl},
  % pdfauthor={Your name here},
  % pdfsubject={Your subject here},
  % pdfkeywords={keyword1, keyword2},
  bookmarksnumbered=true,
  bookmarksopen=true,
  bookmarksopenlevel=1,
  pdfstartview=Fit,
  breaklinks=true, % avoid long links, overrided by url package
  pdfpagemode=UseOutlines,    % pdf toc
  hyperfootnotes=true,
  colorlinks=false,
  pdfborder=0 0 0,
  % pdfpagelayout=TwoPageRight,
  % linktocpage=true, % NO, toc, link only on page no
}
\urlstyle{same} % after hyperref

% uppercase fallback if small caps not available in font
% https://tex.stackexchange.com/questions/233569
\newcommand\detectsc{%
  \setbox0=\hbox{\textsc{i}}%
  \setbox2=\hbox{\textup{i}}%
  % \let\textsc\svtextsc%
  \ifdim\wd0=\wd2\ifdim\ht0=\ht2\let\textsc\uppercase\fi\fi
}

\makeatother % /@@@>
%%%%%%%%%%%%%%
% </TEI> end %
%%%%%%%%%%%%%%
